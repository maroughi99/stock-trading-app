<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Trading Analyzer</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .search-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-box input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-box button {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 600;
        }

        .search-box button:hover {
            background: #5568d3;
        }

        .quick-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-link {
            padding: 8px 15px;
            background: #f5f5f5;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .quick-link:hover {
            background: #667eea;
            color: white;
        }

        .stock-info {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stock-title h2 {
            font-size: 2em;
            color: #333;
        }

        .stock-title p {
            color: #666;
            font-size: 1.1em;
        }

        .stock-price {
            text-align: right;
        }

        .price {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }

        .change {
            font-size: 1.2em;
            font-weight: 600;
            padding: 5px 15px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 5px;
        }

        .change.positive {
            background: #d4edda;
            color: #155724;
        }

        .change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .recommendation-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .recommendation-action {
            font-size: 2.5em;
            font-weight: bold;
        }

        .confidence {
            font-size: 1.5em;
            opacity: 0.9;
        }

        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .signal-group {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .signal-group h4 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .signal-group ul {
            list-style: none;
        }

        .signal-group li {
            padding: 5px 0;
            font-size: 0.95em;
            opacity: 0.95;
        }

        .signal-group li:before {
            content: "‚Ä¢ ";
            font-weight: bold;
            margin-right: 5px;
        }

        .charts-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-wrapper {
            margin-bottom: 40px;
        }

        .chart-wrapper h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .indicator-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .indicator-card h4 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .indicator-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: white;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .signal-history {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .signal-history h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .signal-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .signal-item.buy {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .signal-item.sell {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .signal-item.strong-buy {
            background: #d1ecf1;
            border-left: 4px solid #0056b3;
        }

        .signal-item.strong-sell {
            background: #f8d7da;
            border-left: 4px solid #8b0000;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .stock-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stock-price {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [symbol, setSymbol] = useState('AAPL');
            const [stockData, setStockData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [autoRefresh, setAutoRefresh] = useState(true);
            const [lastUpdate, setLastUpdate] = useState(new Date());
            const priceChartRef = useRef(null);
            const rsiChartRef = useRef(null);
            const macdChartRef = useRef(null);
            const priceChartInstance = useRef(null);
            const rsiChartInstance = useRef(null);
            const macdChartInstance = useRef(null);

            const fetchStockData = async (ticker) => {
                console.log('Fetching stock data for:', ticker);
                setLoading(true);
                setError(null);
                try {
                    const response = await fetch(`https://stock-trading-api.onrender.com/api/stock/${ticker}?period=6mo&interval=1d`);
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Failed to fetch stock data');
                    }
                    const data = await response.json();
                    console.log('Data received:', data);
                    setStockData(data);
                    setLastUpdate(new Date());
                } catch (err) {
                    console.error('Fetch error:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchStockData(symbol);
                
                // Set up auto-refresh every 60 seconds
                if (autoRefresh) {
                    const interval = setInterval(() => {
                        fetchStockData(symbol);
                    }, 60000); // 60 seconds
                    
                    return () => clearInterval(interval);
                }
            }, [symbol, autoRefresh]);

            useEffect(() => {
                if (stockData && stockData.historicalData) {
                    try {
                        console.log('Rendering charts...');
                        // Use setTimeout to ensure DOM is ready
                        setTimeout(() => {
                            renderCharts();
                        }, 100);
                    } catch (err) {
                        console.error('Chart rendering error:', err);
                        setError('Error rendering charts: ' + err.message);
                    }
                }
                
                return () => {
                    if (priceChartInstance.current) priceChartInstance.current.destroy();
                    if (rsiChartInstance.current) rsiChartInstance.current.destroy();
                    if (macdChartInstance.current) macdChartInstance.current.destroy();
                };
            }, [stockData]);

            const renderCharts = () => {
                try {
                    const data = stockData.historicalData;
                    console.log('Historical data points:', data.length);

                    // Check if refs are available
                    if (!priceChartRef.current || !rsiChartRef.current || !macdChartRef.current) {
                        console.error('Chart canvas refs not available');
                        return;
                    }

                    // Destroy existing charts
                    if (priceChartInstance.current) priceChartInstance.current.destroy();
                    if (rsiChartInstance.current) rsiChartInstance.current.destroy();
                    if (macdChartInstance.current) macdChartInstance.current.destroy();

                // Price Chart with Moving Averages and Bollinger Bands
                const priceCtx = priceChartRef.current.getContext('2d');
                priceChartInstance.current = new Chart(priceCtx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [
                            {
                                label: 'Close Price',
                                data: data.map(d => d.close),
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true
                            },
                            {
                                label: 'SMA 20',
                                data: data.map(d => d.sma20),
                                borderColor: '#ff6384',
                                borderWidth: 1.5,
                                pointRadius: 0,
                                borderDash: [5, 5]
                            },
                            {
                                label: 'SMA 50',
                                data: data.map(d => d.sma50),
                                borderColor: '#36a2eb',
                                borderWidth: 1.5,
                                pointRadius: 0,
                                borderDash: [5, 5]
                            },
                            {
                                label: 'BB Upper',
                                data: data.map(d => d.bbUpper),
                                borderColor: 'rgba(255, 99, 132, 0.3)',
                                borderWidth: 1,
                                pointRadius: 0,
                                fill: false
                            },
                            {
                                label: 'BB Lower',
                                data: data.map(d => d.bbLower),
                                borderColor: 'rgba(255, 99, 132, 0.3)',
                                borderWidth: 1,
                                pointRadius: 0,
                                fill: '-1',
                                backgroundColor: 'rgba(255, 99, 132, 0.05)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day'
                                }
                            },
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });

                // RSI Chart
                const rsiCtx = rsiChartRef.current.getContext('2d');
                rsiChartInstance.current = new Chart(rsiCtx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [
                            {
                                label: 'RSI',
                                data: data.map(d => d.rsi),
                                borderColor: '#764ba2',
                                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            },
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 70,
                                        yMax: 70,
                                        borderColor: 'red',
                                        borderWidth: 1,
                                        borderDash: [5, 5]
                                    },
                                    line2: {
                                        type: 'line',
                                        yMin: 30,
                                        yMax: 30,
                                        borderColor: 'green',
                                        borderWidth: 1,
                                        borderDash: [5, 5]
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day'
                                }
                            },
                            y: {
                                min: 0,
                                max: 100
                            }
                        }
                    }
                });

                // MACD Chart
                const macdCtx = macdChartRef.current.getContext('2d');
                macdChartInstance.current = new Chart(macdCtx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [
                            {
                                label: 'MACD',
                                data: data.map(d => d.macd),
                                borderColor: '#667eea',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false
                            },
                            {
                                label: 'Signal',
                                data: data.map(d => d.macdSignal),
                                borderColor: '#ff6384',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false
                            },
                            {
                                label: 'Histogram',
                                data: data.map(d => d.macdHist),
                                type: 'bar',
                                backgroundColor: data.map(d => d.macdHist > 0 ? 'rgba(75, 192, 192, 0.5)' : 'rgba(255, 99, 132, 0.5)'),
                                borderWidth: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day'
                                }
                            }
                        }
                    }
                });
                } catch (error) {
                    console.error('Error in renderCharts:', error);
                    throw error;
                }
            };

            const handleSearch = (e) => {
                e.preventDefault();
                if (symbol.trim()) {
                    fetchStockData(symbol.toUpperCase());
                }
            };

            const handleQuickLink = (ticker) => {
                setSymbol(ticker);
                fetchStockData(ticker);
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>üìà Stock Trading Analyzer</h1>
                        <p>Advanced technical analysis with AI-powered buy/sell signals</p>
                        {stockData && (
                            <small style={{color: '#999', marginTop: '10px', display: 'block'}}>
                                Last updated: {lastUpdate.toLocaleTimeString()}
                                {autoRefresh && ' ‚Ä¢ Auto-refreshing every 60s'}
                            </small>
                        )}
                        <div style={{marginTop: '15px', display: 'flex', gap: '10px', flexWrap: 'wrap'}}>
                            <a href="dashboard.html" style={{
                                padding: '12px 25px',
                                background: '#28a745',
                                color: 'white',
                                borderRadius: '10px',
                                textDecoration: 'none',
                                fontWeight: '600',
                                display: 'inline-block'
                            }}>
                                üéØ View Trading Dashboard
                            </a>
                            <a href="potential.html" style={{
                                padding: '12px 25px',
                                background: '#764ba2',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                textDecoration: 'none',
                                fontWeight: '600',
                                display: 'inline-block',
                                cursor: 'pointer'
                            }}>
                                üìä Price Potential Calculator
                            </a>
                            <a href="daytrading.html" style={{
                                padding: '12px 25px',
                                background: '#1e3c72',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                textDecoration: 'none',
                                fontWeight: '600',
                                display: 'inline-block',
                                cursor: 'pointer'
                            }}>
                                ‚ö° Day Trading Scanner
                            </a>
                            <button onClick={() => setAutoRefresh(!autoRefresh)} style={{
                                padding: '12px 25px',
                                background: autoRefresh ? '#667eea' : '#f5f5f5',
                                color: autoRefresh ? 'white' : '#333',
                                border: 'none',
                                borderRadius: '10px',
                                fontWeight: '600',
                                cursor: 'pointer'
                            }}>
                                {autoRefresh ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Resume'} Auto-Refresh
                            </button>
                        </div>
                    </div>

                    <div className="search-section">
                        <form onSubmit={handleSearch} className="search-box">
                            <input
                                type="text"
                                placeholder="Enter stock symbol (e.g., AAPL, TSLA, MSFT)"
                                value={symbol}
                                onChange={(e) => setSymbol(e.target.value.toUpperCase())}
                            />
                            <button type="submit">Analyze</button>
                        </form>
                        <div className="quick-links">
                            <span style={{marginRight: '10px', color: '#666'}}>Popular:</span>
                            {['AAPL', 'TSLA', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'NFLX'].map(ticker => (
                                <button key={ticker} className="quick-link" onClick={() => handleQuickLink(ticker)}>
                                    {ticker}
                                </button>
                            ))}
                        </div>
                    </div>

                    {loading && (
                        <div className="loading">Loading stock data...</div>
                    )}

                    {error && (
                        <div className="error">
                            <strong>Error:</strong> {error}
                        </div>
                    )}

                    {stockData && !loading && (
                        <>
                            <div className="stock-info">
                                <div className="stock-header">
                                    <div className="stock-title">
                                        <h2>{stockData.symbol}</h2>
                                        <p>{stockData.name}</p>
                                    </div>
                                    <div className="stock-price">
                                        <div className="price">${stockData.currentPrice.toFixed(2)}</div>
                                        <div className={`change ${stockData.change >= 0 ? 'positive' : 'negative'}`}>
                                            {stockData.change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(stockData.change).toFixed(2)} 
                                            ({stockData.changePercent >= 0 ? '+' : ''}{stockData.changePercent.toFixed(2)}%)
                                        </div>
                                    </div>
                                </div>

                                <div className="indicators-grid">
                                    <div className="indicator-card">
                                        <h4>Volume</h4>
                                        <div className="value">{(stockData.volume / 1000000).toFixed(2)}M</div>
                                    </div>
                                    <div className="indicator-card">
                                        <h4>52W High</h4>
                                        <div className="value">${stockData.fiftyTwoWeekHigh?.toFixed(2) || 'N/A'}</div>
                                    </div>
                                    <div className="indicator-card">
                                        <h4>52W Low</h4>
                                        <div className="value">${stockData.fiftyTwoWeekLow?.toFixed(2) || 'N/A'}</div>
                                    </div>
                                    <div className="indicator-card">
                                        <h4>Market Cap</h4>
                                        <div className="value">
                                            {stockData.marketCap ? 
                                                `$${(stockData.marketCap / 1000000000).toFixed(2)}B` : 'N/A'}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {stockData.recommendation && (
                                <div className="recommendation-card">
                                    <div className="recommendation-header">
                                        <div className="recommendation-action">
                                            {stockData.recommendation.action}
                                        </div>
                                        <div className="confidence">
                                            {stockData.recommendation.confidence}% Confidence
                                        </div>
                                    </div>
                                    <p style={{fontSize: '1.1em', marginBottom: '20px', opacity: 0.95}}>
                                        {stockData.recommendation.summary}
                                    </p>
                                    <div className="signals-grid">
                                        {stockData.recommendation.bullishSignals?.length > 0 && (
                                            <div className="signal-group">
                                                <h4>üü¢ Bullish Signals ({stockData.recommendation.bullishSignals.length})</h4>
                                                <ul>
                                                    {stockData.recommendation.bullishSignals.map((signal, idx) => (
                                                        <li key={idx}>{signal}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                        {stockData.recommendation.bearishSignals?.length > 0 && (
                                            <div className="signal-group">
                                                <h4>üî¥ Bearish Signals ({stockData.recommendation.bearishSignals.length})</h4>
                                                <ul>
                                                    {stockData.recommendation.bearishSignals.map((signal, idx) => (
                                                        <li key={idx}>{signal}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                        {stockData.recommendation.neutralSignals?.length > 0 && (
                                            <div className="signal-group">
                                                <h4>‚ö™ Neutral Signals ({stockData.recommendation.neutralSignals.length})</h4>
                                                <ul>
                                                    {stockData.recommendation.neutralSignals.map((signal, idx) => (
                                                        <li key={idx}>{signal}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            <div className="charts-container">
                                <div className="chart-wrapper">
                                    <h3>Price Chart with Moving Averages & Bollinger Bands</h3>
                                    <div style={{height: '400px'}}>
                                        <canvas ref={priceChartRef}></canvas>
                                    </div>
                                </div>

                                <div className="chart-wrapper">
                                    <h3>RSI (Relative Strength Index)</h3>
                                    <div style={{height: '250px'}}>
                                        <canvas ref={rsiChartRef}></canvas>
                                    </div>
                                </div>

                                <div className="chart-wrapper">
                                    <h3>MACD (Moving Average Convergence Divergence)</h3>
                                    <div style={{height: '250px'}}>
                                        <canvas ref={macdChartRef}></canvas>
                                    </div>
                                </div>
                            </div>

                            {stockData.signals && stockData.signals.length > 0 && (
                                <div className="signal-history">
                                    <h3>Recent Trading Signals</h3>
                                    {stockData.signals.map((signal, idx) => (
                                        <div key={idx} className={`signal-item ${signal.type.toLowerCase().replace('_', '-')}`}>
                                            <div>
                                                <strong>{signal.type.replace('_', ' ')}</strong> - ${signal.price.toFixed(2)}
                                                <br/>
                                                <small>{signal.date}</small>
                                                {signal.reasons && signal.reasons.length > 0 && (
                                                    <div style={{marginTop: '5px', fontSize: '0.9em'}}>
                                                        {signal.reasons.slice(0, 3).join(' ‚Ä¢ ')}
                                                    </div>
                                                )}
                                            </div>
                                            <div style={{fontSize: '1.2em', fontWeight: 'bold'}}>
                                                Score: {signal.strength}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
